<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Meta Tags PWA Corrigidas -->
    <meta name="theme-color" content="#0f766e"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Sentinela - Controle BÃ©lico">
    <meta name="description" content="Sistema de controle e reserva de armamento da PolÃ­cia Militar">
    <meta name="keywords" content="armamento, policia militar, reserva, controle, bÃ©lico">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ãcones -->
    <link rel="icon" type="image/png" href="icons/favicon-196.png">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    
    <!-- Splash Screens iOS (reduzido para performance) -->
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">

    <title>Sentinela - Controle BÃ©lico</title>
    
    <!-- Tailwind CSS via CDN (apenas desenvolvimento) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              police: {
                50: '#f0fdfa',
                100: '#ccfbf1',
                200: '#99f6e4',
                300: '#5eead4',
                400: '#2dd4bf',
                500: '#14b8a6',
                600: '#0d9488',
                700: '#0f766e',
                800: '#115e59',
                900: '#134e4a',
              }
            }
          }
        }
      }
    </script>
    
    <style>
      body { 
        font-family: 'Inter', sans-serif; 
        -webkit-tap-highlight-color: transparent;
        background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }
      
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      
      /* Melhorar experiÃªncia PWA */
      @media (display-mode: standalone) {
        body {
          -webkit-user-select: none;
          -webkit-touch-callout: none;
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }

      /* Loading e fallback */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        flex-direction: column;
        gap: 1rem;
        padding: 20px;
      }

      .pwa-status {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 10000;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
      }

      .spinner {
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  
  <body class="text-slate-100">
    <!-- Status PWA para debug -->
    <div id="pwa-status" class="pwa-status">
      ðŸ”„ Verificando...
    </div>

    <!-- ConteÃºdo principal -->
    <div id="root">
      <!-- Fallback enquanto o React carrega -->
      <div class="loading">
        <div class="spinner"></div>
        <h1 class="text-3xl font-bold text-center">ðŸš¨ Sentinela</h1>
        <p class="text-xl text-center">Controle BÃ©lico</p>
        <p class="text-white/80 text-center mt-4">Sistema de Reserva de Armamento da PM</p>
        <div class="mt-8 p-4 bg-white/10 rounded-lg backdrop-blur-lg">
          <p class="text-sm text-center">Se o sistema nÃ£o carregar automaticamente, verifique o console (F12)</p>
        </div>
      </div>
    </div>

    <!-- Service Worker Registration e PWA Detection -->
    <script>
      // =============================================
      // 1. SOLUÃ‡ÃƒO PARA O SERVICE WORKER
      // =============================================
      
      // Criar o Service Worker dinamicamente se nÃ£o existir
      function createServiceWorkerIfNeeded() {
        // Verificar se o arquivo sw.js existe
        return fetch('/sw.js', { method: 'HEAD' })
          .then(response => {
            if (response.status === 404) {
              console.log('ðŸ› ï¸ Criando Service Worker dinamicamente...');
              return registerDynamicServiceWorker();
            }
            return true;
          })
          .catch(error => {
            console.log('ðŸ› ï¸ Service Worker nÃ£o encontrado, criando dinamicamente...');
            return registerDynamicServiceWorker();
          });
      }

      function registerDynamicServiceWorker() {
        const swContent = `
          const CACHE_NAME = 'sentinela-pwa-v1.0.0';
          const urlsToCache = [
            '/',
            '/index.html',
            '/manifest.json',
            '/icons/favicon-196.png'
          ];

          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
                .then(() => self.skipWaiting())
            );
          });

          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => response || fetch(event.request))
            );
          });
        `;

        // Criar um blob URL para o Service Worker
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(blob);
        
        return navigator.serviceWorker.register(swURL)
          .then(registration => {
            console.log('âœ… Service Worker registrado com sucesso (dinÃ¢mico)');
            URL.revokeObjectURL(swURL); // Limpar URL
            return registration;
          });
      }

      // Registrar Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          createServiceWorkerIfNeeded()
            .then(() => {
              updatePWAStatus('Service Worker: âœ… Ativo');
            })
            .catch(error => {
              console.log('âŒ Falha com Service Worker:', error);
              updatePWAStatus('Service Worker: âš ï¸ Offline');
            });
        });
      }

      // =============================================
      // 2. DETECÃ‡ÃƒO DE PWA E INSTALAÃ‡ÃƒO
      // =============================================
      
      let deferredPrompt;

      function checkPWAStatus() {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        const isIOSPWA = window.navigator.standalone;
        
        if (isStandalone || isIOSPWA) {
          updatePWAStatus('âœ… PWA Instalado', '#4ade80');
          document.body.classList.add('pwa-installed');
        } else {
          updatePWAStatus('ðŸŒ No Navegador', '#fbbf24');
        }
      }

      function updatePWAStatus(message, color = '#fbbf24') {
        const element = document.getElementById('pwa-status');
        if (element) {
          element.textContent = message;
          element.style.backgroundColor = color;
        }
        console.log('ðŸ“± Status PWA:', message);
      }

      // Evento para instalaÃ§Ã£o do PWA
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        updatePWAStatus('ðŸ“¥ Clique para Instalar', '#60a5fa');
        
        // Mostrar botÃ£o de instalaÃ§Ã£o
        showInstallPrompt();
      });

      function showInstallPrompt() {
        const existingBtn = document.getElementById('install-btn');
        if (existingBtn) return;

        const installBtn = document.createElement('button');
        installBtn.id = 'install-btn';
        installBtn.innerHTML = 'ðŸ“¥ Instalar App';
        installBtn.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: #0f766e;
          color: white;
          border: none;
          padding: 12px 16px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        
        installBtn.onclick = async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              updatePWAStatus('âœ… Instalando...', '#4ade80');
              installBtn.remove();
            }
            deferredPrompt = null;
          }
        };
        
        document.body.appendChild(installBtn);
      }

      // =============================================
      // 3. INICIALIZAÃ‡ÃƒO
      // =============================================
      
      window.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸš€ Sentinela PWA - Inicializado');
        console.log('ðŸ“± User Agent:', navigator.userAgent);
        
        checkPWAStatus();
        
        // Verificar se React carregou apÃ³s 3 segundos
        setTimeout(() => {
          if (!window.React) {
            console.warn('âš ï¸ React nÃ£o detectado - Modo estÃ¡tico ativo');
            updatePWAStatus('âš¡ Modo EstÃ¡tico', '#8b5cf6');
          }
        }, 3000);
      });

      // Prevenir zoom duplo no iOS
      document.addEventListener('touchstart', function(event) {
        if (event.touches.length > 1) event.preventDefault();
      });

      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) event.preventDefault();
        lastTouchEnd = now;
      }, false);

    </script>
  </body>
</html>
